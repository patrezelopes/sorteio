<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste do Backend - Sorteio</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }

        .status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 18px;
        }

        .success {
            background: #22c55e;
            color: white;
        }

        .error {
            background: #ef4444;
            color: white;
        }

        .warning {
            background: #f59e0b;
            color: white;
        }

        button {
            background: linear-gradient(135deg, #8a50ff, #e8527d);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px 5px;
        }

        button:hover {
            opacity: 0.9;
        }

        pre {
            background: #2d2d44;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }

        h1 {
            color: #8a50ff;
        }

        h2 {
            color: #e8527d;
        }
    </style>
</head>

<body>
    <h1>üß™ Teste do Backend - Sistema de Sorteio</h1>

    <div id="status" class="status warning">
        ‚è≥ Aguardando teste...
    </div>

    <h2>Instru√ß√µes:</h2>
    <ol>
        <li>Abra um terminal e execute:
            <pre>cd /home/patreze/dev/sorteio/backend
pip install -r requirements.txt
python main.py</pre>
        </li>
        <li>Clique no bot√£o abaixo para testar se o backend est√° rodando:</li>
    </ol>

    <button onclick="testBackend()">üîç Testar Backend</button>
    <button onclick="testFullFlow()">üé≤ Testar Fluxo Completo</button>

    <div id="results"></div>

    <script>
        const API_URL = 'http://localhost:8000';

        async function testBackend() {
            const status = document.getElementById('status');
            const results = document.getElementById('results');

            status.className = 'status warning';
            status.textContent = '‚è≥ Testando conex√£o com o backend...';
            results.innerHTML = '';

            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                status.className = 'status success';
                status.textContent = '‚úÖ Backend est√° rodando!';
                results.innerHTML = `
                    <h3>Resposta do servidor:</h3>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                    <p>‚úÖ API Version: ${data.version}</p>
                    <p>‚úÖ Documenta√ß√£o dispon√≠vel em: <a href="${API_URL}/docs" target="_blank">${API_URL}/docs</a></p>
                `;
            } catch (error) {
                status.className = 'status error';
                status.textContent = '‚ùå Backend n√£o est√° rodando!';
                results.innerHTML = `
                    <h3>Erro:</h3>
                    <pre>${error.message}</pre>
                    <p>‚ö†Ô∏è Certifique-se de que o backend est√° rodando na porta 8000</p>
                `;
            }
        }

        async function testFullFlow() {
            const status = document.getElementById('status');
            const results = document.getElementById('results');

            status.className = 'status warning';
            status.textContent = '‚è≥ Executando teste completo...';
            results.innerHTML = '<h3>Executando testes...</h3>';

            const log = [];

            try {
                // Test 1: Create participant
                log.push('üìù Criando participante...');
                const participant = await fetch(`${API_URL}/api/participants/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Jo√£o Teste',
                        email: `teste${Date.now()}@email.com`,
                        phone: '(11) 98765-4321'
                    })
                }).then(r => r.json());
                log.push(`‚úÖ Participante criado: ${participant.name} (ID: ${participant.id})`);

                // Test 2: Create raffle
                log.push('üé´ Criando sorteio...');
                const raffle = await fetch(`${API_URL}/api/raffles/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Teste Autom√°tico',
                        description: 'Sorteio de teste'
                    })
                }).then(r => r.json());
                log.push(`‚úÖ Sorteio criado: ${raffle.name} (ID: ${raffle.id})`);

                // Test 3: Assign ticket
                log.push('üéüÔ∏è Atribuindo ingresso...');
                const tickets = await fetch(`${API_URL}/api/raffles/${raffle.id}/assign-tickets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tickets: [{
                            participant_id: participant.id,
                            ticket_number: '001'
                        }]
                    })
                }).then(r => r.json());
                log.push(`‚úÖ Ingresso atribu√≠do: #${tickets[0].ticket_number}`);

                // Test 4: Perform draw
                log.push('üé≤ Realizando sorteio...');
                const drawResult = await fetch(`${API_URL}/api/raffles/${raffle.id}/draw`, {
                    method: 'POST'
                }).then(r => r.json());
                log.push(`‚úÖ Sorteio realizado!`);
                log.push(`üèÜ VENCEDOR: ${drawResult.winner_ticket.participant.name} - Ingresso #${drawResult.winner_ticket.ticket_number}`);

                status.className = 'status success';
                status.textContent = '‚úÖ Todos os testes passaram!';
                results.innerHTML = `
                    <h3>Resultados dos Testes:</h3>
                    <pre>${log.join('\n')}</pre>
                    <h3>Dados do Vencedor:</h3>
                    <pre>${JSON.stringify(drawResult.winner_ticket, null, 2)}</pre>
                `;
            } catch (error) {
                status.className = 'status error';
                status.textContent = '‚ùå Erro durante os testes!';
                results.innerHTML = `
                    <h3>Log dos Testes:</h3>
                    <pre>${log.join('\n')}</pre>
                    <h3>Erro:</h3>
                    <pre>${error.message}</pre>
                `;
            }
        }
    </script>
</body>

</html>